<script>
    function getScheduleCallBack(data, arg, divId) {
        //console.log();
        //alert(data);
        var sch = JSON.parse(data).schedule;
        console.log(sch);
        var schList = sch.O_RESULT_CURSOR;
        console.log(schList);
        var apdp = sch.rd_apdpDate;
        var tsList = getTSSchSort(schList);
        console.log(tsList);
        var newList = new Array();
        var newItem;
        if (isSearch && sch.O_ERROR_FLAG == 'Y') comLib.messageOut(sch.O_MESSAGE_CODE);
        if (isSearch && schList.length == 0) comLib.messageOut("0", 'Schedule');

        for (var i = 0; i < schList.length; i++) {
            console.log(schList[i].POL_REVISED_APDP_DATE + ' ' + schList[i].GUBUN + ' ' + schList[i].SEC_SEQ);
            if (parseInt(schList[i].SEC_SEQ) > 1) continue;
            var apdp_date = '';
            var detail_cont_id = '';
            var voy_no = '';
            if (apdp == 'O') {
                apdp_date = schList[i].POL_REVISED_APDP_DATE;
                detail_cont_id = 'ex_detail';
                voy_no = schList[i].EXP_VOY_NO;
            } else if (apdp == 'I') {
                apdp_date = schList[i].POD_REVISED_APDP_DATE;
                detail_cont_id = 'im_detail';
                voy_no = schList[i].IMP_VOY_NO;
            }

            if (apdp_date.substring(0, 6) != pcCalendar.cur_year + util_lpad(pcCalendar.cur_month, 2, '0')) continue;

            newItem = schList[i];
            apdp_date_day = apdp_date.substring(6, 8);
            var closeYN = schList[i].CLOSED == 'CLOSED' ? 'end' : schList[i].CLOSED == 'CHECK' ? 'end' : 'ing';
            var tooltip = '';
            if (closeYN == 'ing') {
                tooltip = "<span class='tooltip'><span id='WEB_201_C_VOY'>항차</span> : " + voy_no + "(" + (schList[i].TS == 'N' ? 'Direct' : 'TS') + ")<br /> ETD : " + getDateFormat(schList[i].POL_REVISED_APDP_DATE + schList[i].POL_REVISED_APDP_TM, 'YYYY/MM/DD HH:MI') + "<br /> ETA : " + getDateFormat(schList[i].POD_REVISED_APDP_DATE + schList[i].POD_REVISED_APDP_TM, 'YYYY/MM/DD HH:MI') + "</span>";
            } else {
                if (schList[i].CLOSED == 'CLOSED') tooltip = "<span class='tooltip'>" + bkg_closed_msg + "</span>";//"해당 선박은 Booking이 마감되었습니다.<br /> 다른 선박을 선택하여 주시기 바랍니다.";
                else if (schList[i].CLOSED == 'CHECK') tooltip = "<span class='tooltip'>" + bkg_check_msg + "</span>";
            }

            var tsSchNo = '';

            $.add_vsl = $("<li class='calendar-list' id='" + schList[i].VSL_CD + "' pol_sch_no='" + schList[i].POL_SCH_NO + "' pod_sch_no='" + schList[i].POD_SCH_NO + "' ts='" + schList[i].TS + "'><a href='#none' class='" + closeYN + "'>" + schList[i].VSL_NM + "<font color='red' size='0.5'>" + (schList[i].TS == 'N' ? '' : '(TS)') + "</font></a>" + tooltip + "</li>");
            $.add_vsl.attr("pol_sch_no", schList[i].POL_SCH_NO);
            $.add_vsl.attr("pod_sch_no", schList[i].POD_SCH_NO);
            $.add_vsl.attr("gubun", schList[i].GUBUN);
            $.add_vsl.attr("sec_seq", schList[i].SEC_SEQ);
            $.add_vsl.attr("vsl_cd", schList[i].VSL_CD);
            $.add_vsl.attr("vsl_nm", schList[i].VSL_NM);
            $.add_vsl.attr("voy_no", voy_no);
            $.add_vsl.attr("pol_country_cd", schList[i].POL_COUNTRY_CD);
            $.add_vsl.attr("pol_port_cd", schList[i].POL_PORT_CD);
            $.add_vsl.attr("pod_country_cd", schList[i].POD_COUNTRY_CD);
            $.add_vsl.attr("pod_port_cd", schList[i].POD_PORT_CD);
            $.add_vsl.attr("closed", schList[i].CLOSED);
            $.add_vsl.attr("ts_seq", 1);

            if (schList[i].TS == 'Y') {
                var tsSchArr = {};
                if (tsList.arr2.length > 0) {
                    tsSchArr = getTSSchNo(schList[i].POD_REVISED_APDP_DATE + schList[i].POD_REVISED_APDP_TM, tsList.arr2);
                    if (tsSchArr.POL_SCH_NO != undefined) {
                        $.add_vsl.attr("pol_sch_no_ts2", tsSchArr.POL_SCH_NO);
                        $.add_vsl.attr("pod_sch_no_ts2", tsSchArr.POD_SCH_NO);
                        $.add_vsl.attr("gubun_ts2", tsSchArr.GUBUN);
                        $.add_vsl.attr("sec_seq_ts2", tsSchArr.SEC_SEQ);
                        $.add_vsl.attr("vsl_cd_ts2", tsSchArr.VSL_CD);
                        $.add_vsl.attr("vsl_nm_ts2", tsSchArr.VSL_NM);
                        $.add_vsl.attr("voy_no_ts2", tsSchArr.EXP_VOY_NO);
                        $.add_vsl.attr("pol_country_cd_ts2", tsSchArr.POL_COUNTRY_CD);
                        $.add_vsl.attr("pol_port_cd_ts2", tsSchArr.POL_PORT_CD);
                        $.add_vsl.attr("pod_country_cd_ts2", tsSchArr.POD_COUNTRY_CD);
                        $.add_vsl.attr("pod_port_cd_ts2", tsSchArr.POD_PORT_CD);
                        $.add_vsl.attr("ts_seq", 2);

                        newItem.TS = tsSchArr.POL;
                        newItem.TT = parseInt(newItem.TT) + parseInt(tsSchArr.TT);
                        newItem.POD = tsSchArr.POD;
                    }
                }
                if (tsList.arr3.length > 0) {
                    tsSchArr = getTSSchNo(schList[i].POD_REVISED_APDP_DATE + schList[i].POD_REVISED_APDP_TM, tsList.arr3);
                    $.add_vsl.attr("pol_sch_no_ts3", tsSchArr.POL_SCH_NO);
                    $.add_vsl.attr("pod_sch_no_ts3", tsSchArr.POD_SCH_NO);
                    $.add_vsl.attr("gubun_ts3", tsSchArr.GUBUN);
                    $.add_vsl.attr("sec_seq_ts3", tsSchArr.SEC_SEQ);
                    $.add_vsl.attr("vsl_cd_ts3", tsSchArr.VSL_CD);
                    $.add_vsl.attr("vsl_nm_ts3", tsSchArr.VSL_NM);
                    $.add_vsl.attr("voy_no_ts3", tsSchArr.EXP_VOY_NO);
                    $.add_vsl.attr("pol_country_cd_ts3", tsSchArr.POL_COUNTRY_CD);
                    $.add_vsl.attr("pol_port_cd_ts3", tsSchArr.POL_PORT_CD);
                    $.add_vsl.attr("pod_country_cd_ts3", tsSchArr.POD_COUNTRY_CD);
                    $.add_vsl.attr("pod_port_cd_ts3", tsSchArr.POD_PORT_CD);
                    $.add_vsl.attr("ts_seq", 3);

                    newItem.TS += '<br/>' + tsSchArr.POL;
                    newItem.TT = parseInt(newItem.TT) + parseInt(tsSchArr.TT);
                    newItem.POD = tsSchArr.POD;
                }

                newList.push(newItem);
            } else newList.push(newItem);

            $.add_vsl.click(function () {

                var listDiv = $(this).parents('tr').next().find('.detail-cont#' + detail_cont_id);
                listDiv.children(':not(#' + detail_cont_id + '_1)').remove();
                getDataWeb201BCR($(this), apdp, detail_cont_id, 'N');
                if ($(this).attr("ts") == 'Y') {
                    for (var i = 1; i < parseInt($(this).attr("ts_seq")); i++) {
                        getDataWeb201BCR($(this), apdp, detail_cont_id, 'ts' + (i + 1));
                    }
                }

            });
            $.add_vsl.hover(function () {
                $(this).children(".tooltip").show();
            }, function () {
                $(this).children(".tooltip").hide();
            });
            $("#" + pcCalendar.id + "_" + parseInt(apdp_date_day) + "_date").append($.add_vsl);
            //html.push("<li><a href='#none'>HEUNG-A</a></li>");
            //"+pcCalendar.id+"_"+i+"_date

        }


        /*for (var i=0;i<schList.length;i++){
            if (schList[i].)
        }*/
        var grid = $("#gridList");
        grid.jqGrid('clearGridData');
        grid.jqGrid('setGridParam', {datatype: "local", data: newList}).trigger("reloadGrid");

        comLib.getScreenIetm("WEB_201_B", null, headerNameBRCallbackFs);
        comLib.getScreenIetm("WEB_201_C", null, headerNameCRCallbackFs);
        inq_ing = false;
        $("#loading-bar").hide();
    }

    function getTSSchSort(arr) {
        var result = {};
        var arr2 = new Array();
        var arr3 = new Array();
        result.arr2 = arr2;
        result.arr3 = arr3;

        for (var i = 0; i < arr.length; i++) {
            if (arr[i].GUBUN == '2' && parseInt(arr[i].SEC_SEQ) == 2) arr2.push(arr[i]);
            else if (arr[i].GUBUN == '2' && parseInt(arr[i].SEC_SEQ == 3)) arr3.push(arr[i]);
            else continue;
        }
        if (arr2.length != 0) {
            arr2.sort(function (a, b) {
                var fdtm = a.POD_REVISED_APDP_DATE + a.POD_REVISED_APDP_TM;
                var sdtm = b.POD_REVISED_APDP_DATE + b.POD_REVISED_APDP_TM;
                return fdtm < sdtm ? -1 : fdtm > sdtm ? 1 : 0;
            });
            result.arr2 = arr2;
        }
        if (arr3.length != 0) {
            arr3.sort(function (a, b) {
                var fdtm = a.POD_REVISED_APDP_DATE + a.POD_REVISED_APDP_TM;
                var sdtm = b.POD_REVISED_APDP_DATE + b.POD_REVISED_APDP_TM;
                return fdtm < sdtm ? -1 : fdtm > sdtm ? 1 : 0;
            });
            result.arr3 = arr3;
        }

        return result;
    }

    function getTSSchNo(apdp_dtm, arr) {
        var result = {};
        //result.POL_SCH_NO = '';
        //result.POD_SCH_NO = '';
        for (var i = 0; i < arr.length; i++) {
            console.log(arr[i].POL_REVISED_APDP_DATE + arr[i].POL_REVISED_APDP_TM + ' ' + apdp_dtm);
            if (arr[i].POL_REVISED_APDP_DATE + arr[i].POL_REVISED_APDP_TM >= apdp_dtm) {
                //result.POL_SCH_NO = arr[i].POL_SCH_NO;
                //result.POD_SCH_NO = arr[i].POD_SCH_NO;
                return arr[i];
            }
        }
        return result;
    }
</script>